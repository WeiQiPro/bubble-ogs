<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"
      integrity="sha512-zoJXRvW2gC8Z0Xo3lBbao5+AS3g6YWr5ztKqaicua11xHo+AvE1b0lT9ODgrHTmNUxeCw0Ry4BGRYZfXu70weg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>

  <body>
    <script>
let OGS={set:!1};class Board{constructor(){this.grid=Array.from({length:19},(()=>Array(19).fill(""))),this.size=19}playMove(t,e){const[n,r,o=0]=t,s="b"===e?"w":"b";this.grid[n][r]=e;this.findGroups().forEach((({color:t,group:e})=>{t===s&&0===this.calculateLiberties(e)&&e.forEach((([t,e])=>this.grid[t][e]=""))}))}findGroups(){const t=[],e=Array(this.size).fill(!1).map((()=>Array(this.size).fill(!1))),n=[[-1,0],[1,0],[0,-1],[0,1]];for(let r=0;r<this.size;r++)for(let o=0;o<this.size;o++){const s=this.grid[r][o];if(s&&!e[r][o]){const l=[],i=[[r,o]];for(;i.length>0;){const[t,r]=i.pop();if(!e[t][r]){e[t][r]=!0,l.push([t,r]);for(const[o,l]of n){const n=t+o,u=r+l;n<0||n>=this.size||u<0||u>=this.size||(this.grid[n][u]!==s||e[n][u]||i.push([n,u]))}}}t.push({color:s,group:l})}}return t}calculateLiberties(t){const e=new Set,n=[[-1,0],[1,0],[0,-1],[0,1]];for(const[r,o]of t)for(const[t,s]of n){const n=r+t,l=o+s;n<0||n>=this.size||l<0||l>=this.size||""===this.grid[n][l]&&e.add([n,l].toString())}return e.size}state(t,e){this.grid=Array.from({length:19},(()=>Array(19).fill("")));for(let n=0;n<e.length;n++){const[r,o]=e[n];if(-1===r||-1===o)continue;let s;s=n<t?"b":(n-t)%2==0?"w":"b",this.playMove([r,o],s)}return this.grid}}function start(t){const e=new Image;e.src=t.param1;const n=new Image;n.src=t.param2;const r=new Image;r.src=t.param3;domloader(document.querySelectorAll(".goban"),e,n,r)}function domloader(t,e,n,r){0==OGS.set?(OGS=loadSocket(),OGS.set=!0,OGS.board=new Board,OGS.GAMES={},t.forEach((t=>{const o=t.innerText,[s,l]=o.split("/").map((t=>t.split(":")[1]));createGoBoardSVG(t.id,e,s,l),OGS.GAMES[l]={id:l,type:s,moves:[],state:[]},subscribeToGames(OGS,s,l,n,r)}))):Object.keys(OGS.GAMES).forEach((t=>{const e=OGS.GAMES[t];let o=e.id,s=e.type,l=e.moves;updateBoard(e.state,s,o,n,r),markCurrentMove(l[l.length-1],s,o,n)}))}function subscribeToGames(t,e,n,r,o){if("game"===e)t.emit("game/connect",{game_id:n,chat:!1}),t.on("game/"+n+"/gamedata",(s=>{if("finished"===s.phase){console.log("game has finished");const l=s.moves,i=s.handicap;return t.GAMES[n].handicap=s.handicap,t.GAMES[n].moves=l,t.GAMES[n].state=t.board.state(i,l),updateBoard(t.GAMES[n].state,e,n,r,o),markCurrentMove(l[l.length-1],e,n,r),void t.send(["game/disconnect",{game_id:n}])}if(!s.moves)return;const l=s.moves,i=s.handicap;t.GAMES[n].handicap=i,t.GAMES[n].moves=l,t.GAMES[n].state=t.board.state(i,l),updateBoard(t.GAMES[n].state,e,n,r,o),markCurrentMove(l[l.length-1],e,n,r)})),t.on("game/"+n+"/move",(s=>{if(!s.move)return;const l=s.move,i=t.GAMES[n].handicap;t.GAMES[n].moves.push(l),t.GAMES[n].state=t.board.state(i,t.GAMES[n].moves),updateBoard(t.GAMES[n].state,e,n,r,o),markCurrentMove(l,e,n,r)}));else{if("review"!==e)return;t.emit("review/connect",{review_id:n,chat:!1}),t.on(`review/${n}/full_state`,(s=>{const l=s[s.length-1].m;console.log(l),t.GAMES[n].moves=returnArrayOfMoves(t.GAMES[n],l);let i=t.GAMES[n].moves.length;t.GAMES[n].state=t.board.state(t.GAMES[n].handicap,t.GAMES[n].moves),updateBoard(t.GAMES[n].state,e,n,r,o),markCurrentMove(t.GAMES[n].moves[i-1],e,n,r)})),t.on(`review/${n}/r`,(s=>{if(s.m){const l=t.GAMES[n].handicap,i=s.m;t.GAMES[n].moves=returnArrayOfMoves(t.GAMES[n],i);let u=t.GAMES[n].moves.length;t.GAMES[n].state=t.board.state(l,t.GAMES[n].moves),updateBoard(t.GAMES[n].state,e,n,r,o),markCurrentMove(t.GAMES[n].moves[u-1],e,n,r)}}))}}function returnArrayOfMoves(t,e){const n="abcdefghijklmnopqrs";let r=[];for(let t=0;t<e.length;t+=2)r.push(e.substring(t,t+2));return t.handicap=1,r=r.filter((e=>"!1"!==e||(t.handicap++,!1))),r.map((t=>{if(2===t.length){let e=n.indexOf(t[0]),r=n.indexOf(t[1]);if(-1!==e&&-1!==r)return[e,r]}return null})).filter((t=>null!==t))}function markCurrentMove(t,e,n,r){const[o,s,l=0]=t;let i=document.getElementById(`stone-${o}-${s}-${e}-${n}`);if(i){let t=i.parentNode;const l=i.getAttribute("href")==r.src?"#e8e8e8":"#111111";let u=document.getElementById(`current-move-${e}-${n}`);u&&u.remove();let a=parseFloat(i.getAttribute("width"))/2,c=document.createElementNS("http://www.w3.org/2000/svg","circle"),d=parseFloat(i.getAttribute("x"))+a,S=parseFloat(i.getAttribute("y"))+a;c.setAttribute("cx",d),c.setAttribute("cy",S),c.setAttribute("r",.5*a),c.setAttribute("stroke-width","2.6315789473684212"),c.setAttribute("fill","none"),c.setAttribute("class","circle-label"),c.setAttribute("stroke",l),c.setAttribute("id",`current-move-${e}-${n}`),c.setAttribute("class",`current-move-${o}-${s}-${e}-${n}`),t.appendChild(c)}}function updateBoard(t,e,n,r,o){for(let s=0;s<19;s++)for(let l=0;l<19;l++){let i=document.getElementById(`stone-${s}-${l}-${e}-${n}`);i&&("b"===t[s][l]?i.setAttribute("href",r.src):"w"===t[s][l]?i.setAttribute("href",o.src):i.setAttribute("href",""))}}function createGoBoardSVG(t,e,n,r){const o="http://www.w3.org/2000/svg",s=19,l=50,i=600,u=i/18,a=document.createElementNS(o,"svg");a.setAttributeNS(null,"viewBox","0 0 700 700"),a.setAttributeNS(null,"class","board"),a.setAttributeNS(null,"id",`board-${n}-${r}`),a.style.overflow="visible",a.style.width="100%",a.style.height="100%";const c=document.createElementNS(o,"rect");c.setAttributeNS(null,"x",l),c.setAttributeNS(null,"y",l),c.setAttributeNS(null,"width",i),c.setAttributeNS(null,"height",i),c.setAttributeNS(null,"fill","rgba(0, 0, 0, 0.05)"),a.appendChild(c);const d=document.createElementNS(o,"g");d.setAttributeNS(null,"class","label"),a.appendChild(d);const S=document.createElementNS(o,"g");S.setAttributeNS(null,"class","lines"),a.appendChild(S);for(let t=0;t<s;t++){const e=l+t*u,n=document.createElementNS(o,"line");n.setAttributeNS(null,"x1",l),n.setAttributeNS(null,"y1",e),n.setAttributeNS(null,"x2",650),n.setAttributeNS(null,"y2",e),n.setAttributeNS(null,"stroke","#000"),S.appendChild(n);const r=document.createElementNS(o,"line");r.setAttributeNS(null,"x1",e),r.setAttributeNS(null,"y1",l),r.setAttributeNS(null,"x2",e),r.setAttributeNS(null,"y2",650),r.setAttributeNS(null,"stroke","#000"),S.appendChild(r)}[{x:3,y:3},{x:9,y:3},{x:15,y:3},{x:3,y:9},{x:9,y:9},{x:15,y:9},{x:3,y:15},{x:9,y:15},{x:15,y:15}].forEach((t=>{const e=document.createElementNS(o,"circle");e.setAttributeNS(null,"cx",l+t.x*u),e.setAttributeNS(null,"cy",l+t.y*u),e.setAttributeNS(null,"r",5),e.setAttributeNS(null,"fill","#000"),a.appendChild(e)}));for(let t=0;t<s;t++){const e=l+t*u,n=s-t,r=String.fromCharCode("A".charCodeAt(0)+(t>=8?t+1:t)),i=document.createElementNS(o,"text");i.setAttributeNS(null,"x",e),i.setAttributeNS(null,"y",25),i.setAttributeNS(null,"font-size","21"),i.setAttributeNS(null,"text-anchor","middle"),i.setAttributeNS(null,"dy","0.35em"),i.setAttributeNS(null,"stroke","#080808"),i.setAttributeNS(null,"fill","#080808"),i.textContent=r,d.appendChild(i);const a=i.cloneNode(!0);a.setAttributeNS(null,"y",675),d.appendChild(a);const c=document.createElementNS(o,"text");c.setAttributeNS(null,"x",25),c.setAttributeNS(null,"y",e),c.setAttributeNS(null,"font-size","21"),c.setAttributeNS(null,"text-anchor","middle"),c.setAttributeNS(null,"dy","0.35em"),c.setAttributeNS(null,"stroke","#080808"),c.setAttributeNS(null,"fill","#080808"),c.textContent=n,d.appendChild(c);const S=c.cloneNode(!0);S.setAttributeNS(null,"x",675),d.appendChild(S)}const m=document.createElementNS(o,"g");m.setAttributeNS(null,"id",`stonesGroup-${n}-${r}`),a.appendChild(m);for(let t=0;t<s;t++)for(let e=0;e<s;e++){const s=l+t*u,i=l+e*u,a=document.createElementNS(o,"image");a.setAttributeNS(null,"x",s-16.5),a.setAttributeNS(null,"y",i-16.5),a.setAttributeNS(null,"width",33),a.setAttributeNS(null,"height",33),a.setAttributeNS("http://www.w3.org/1999/xlink","href",""),a.setAttributeNS(null,"id",`stone-${t}-${e}-${n}-${r}`),m.appendChild(a)}const A=document.getElementById(t),h=A.parentElement,b=Math.min(h.clientWidth,h.clientHeight);A?h?(A.style.width=`${b}px`,A.style.height=`${b}px`,A.style.backgroundImage=`url(${e.src})`,A.innerHTML="",A.appendChild(a)):console.error(`Parent element of '${t}' not found.`):console.error(`Element with ID '${t}' not found.`)}function loadSocket(){const t=io("https://online-go.com",{transports:["websocket"]});return t.on("connect",(()=>{console.log("OGS connected"),t.emit("hostinfo"),t.emit("authenticate",{device_id:"bubble-viewer"})})),t.on("hostinfo",(t=>{console.log("Termination server",t)})),t.on("authenticate",(t=>{console.log(t)})),t.on("disconnect",(()=>{console.log("Disconnected from OGS. Attempting to reconnect...")})),t.on("error",(t=>{console.error("Socket connection error:",t)})),t}</script>
  </body>
</html>
