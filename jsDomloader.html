<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"
      integrity="sha512-zoJXRvW2gC8Z0Xo3lBbao5+AS3g6YWr5ztKqaicua11xHo+AvE1b0lT9ODgrHTmNUxeCw0Ry4BGRYZfXu70weg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>

  <body>
    <script>
      let OGS={set:!1};class Board{constructor(){this.grid=Array.from({length:19},(()=>Array(19).fill(""))),this.size=19}playMove(t,e){const[r,n,s=0]=t,o="b"===e?"w":"b";this.grid[r][n]=e;this.findGroups().forEach((({color:t,group:e})=>{t===o&&0===this.calculateLiberties(e)&&e.forEach((([t,e])=>this.grid[t][e]=""))}))}findGroups(){const t=[],e=Array(this.size).fill(!1).map((()=>Array(this.size).fill(!1))),r=[[-1,0],[1,0],[0,-1],[0,1]];for(let n=0;n<this.size;n++)for(let s=0;s<this.size;s++){const o=this.grid[n][s];if(o&&!e[n][s]){const l=[],i=[[n,s]];for(;i.length>0;){const[t,n]=i.pop();if(!e[t][n]){e[t][n]=!0,l.push([t,n]);for(const[s,l]of r){const r=t+s,u=n+l;r<0||r>=this.size||u<0||u>=this.size||(this.grid[r][u]!==o||e[r][u]||i.push([r,u]))}}}t.push({color:o,group:l})}}return t}calculateLiberties(t){const e=new Set,r=[[-1,0],[1,0],[0,-1],[0,1]];for(const[n,s]of t)for(const[t,o]of r){const r=n+t,l=s+o;r<0||r>=this.size||l<0||l>=this.size||""===this.grid[r][l]&&e.add([r,l].toString())}return e.size}state(t,e){this.grid=Array.from({length:19},(()=>Array(19).fill("")));for(let r=0;r<e.length;r++){const[n,s]=e[r];if(-1===n||-1===s)continue;let o;o=t>=2?r<t?"b":(r-t)%2==0?"w":"b":r%2==0?"b":"w",this.playMove([n,s],o)}return this.grid}}function start(t){const e=new Image;e.src=t.param1;const r=new Image;r.src=t.param2;const n=new Image;n.src=t.param3;domloader(document.querySelectorAll(".goban"),e,r,n)}function domloader(t,e,r,n){0==OGS.set?(OGS=loadSocket(),OGS.set=!0,OGS.board=new Board,OGS.GAMES={},t.forEach((t=>{const s=t.innerText,[o,l]=s.split("/").map((t=>t.split(":")[1]));createGoBoardSVG(t.id,e,o,l),OGS.GAMES[l]={id:l,type:o,moves:[],state:[]},subscribeToGames(OGS,o,l,r,n)}))):Object.keys(OGS.GAMES).forEach((t=>{const e=OGS.GAMES[t];let s=e.id,o=e.type,l=e.moves;updateBoard(e.state,o,s,r,n),markCurrentMove(l[l.length-1],o,s,r)}))}function subscribeToGames(t,e,r,n,s){if("game"===e)t.emit("game/connect",{game_id:r,chat:!1}),t.on("game/"+r+"/gamedata",(o=>{if("finished"===o.phase){console.log("game has finished");const l=o.moves,i=o.handicap;return t.GAMES[r].handicap=o.handicap,t.GAMES[r].moves=l,t.GAMES[r].state=t.board.state(i,l),updateBoard(t.GAMES[r].state,e,r,n,s),markCurrentMove(l[l.length-1],e,r,n),void t.send(["game/disconnect",{game_id:r}])}if(!o.moves)return;const l=o.moves,i=o.handicap;t.GAMES[r].handicap=i,t.GAMES[r].moves=l,t.GAMES[r].state=t.board.state(i,l),updateBoard(t.GAMES[r].state,e,r,n,s),markCurrentMove(l[l.length-1],e,r,n)})),t.on("game/"+r+"/move",(o=>{if(!o.move)return;const l=o.move,i=t.GAMES[r].handicap;t.GAMES[r].moves.push(l),t.GAMES[r].state=t.board.state(i,t.GAMES[r].moves),updateBoard(t.GAMES[r].state,e,r,n,s),markCurrentMove(l,e,r,n)}));else{if("review"!==e)return;t.emit("review/connect",{review_id:r,chat:!1}),t.on(`review/${r}/full_state`,(o=>{const l=o[o.length-1].m;console.log(l),t.GAMES[r].moves=returnArrayOfMoves(t.GAMES[r],l);let i=t.GAMES[r].moves.length;t.GAMES[r].state=t.board.state(t.GAMES[r].handicap,t.GAMES[r].moves),updateBoard(t.GAMES[r].state,e,r,n,s),markCurrentMove(t.GAMES[r].moves[i-1],e,r,n)})),t.on(`review/${r}/r`,(o=>{if(o.m){const l=t.GAMES[r].handicap,i=o.m;t.GAMES[r].moves=returnArrayOfMoves(t.GAMES[r],i);let u=t.GAMES[r].moves.length;t.GAMES[r].state=t.board.state(l,t.GAMES[r].moves),updateBoard(t.GAMES[r].state,e,r,n,s),markCurrentMove(t.GAMES[r].moves[u-1],e,r,n)}}))}}function returnArrayOfMoves(t,e){const r="abcdefghijklmnopqrs";let n="",s=0;for(;s<e.length;){if(!(s+5<e.length)){n+=e.substring(s);break}{const t=e.substring(s,s+4),r=e.substring(s+4,s+8);t.startsWith("!1")&&r.startsWith("!2")||t.startsWith("!2")&&r.startsWith("!1")?(n+=t+"....",s+=4):t.startsWith("!1")||t.startsWith("!2")?(n+=t+"..",s+=4):(n+=t.substring(0,2),s+=2)}}let o=[];for(s=0;s<n.length;s+=2)o.push(n.substring(s,s+2));return t.handicap=1,o=o.filter((t=>"!1"!==t&&"!2"!==t)),o.map((t=>{let e,n;return 2===t.length?(".."===t?(e=-1,n=-1,console.log("pass")):(e=r.indexOf(t[0]),n=r.indexOf(t[1])),[e,n]):null})).filter((t=>null!==t))}function markCurrentMove(t,e,r,n){const[s,o,l=0]=t;let i=document.getElementById(`stone-${s}-${o}-${e}-${r}`);if(i){let t=i.parentNode;const l=i.getAttribute("href")==n.src?"#e8e8e8":"#111111";let u=document.getElementById(`current-move-${e}-${r}`);u&&u.remove();let a=parseFloat(i.getAttribute("width"))/2,c=document.createElementNS("http://www.w3.org/2000/svg","circle"),d=parseFloat(i.getAttribute("x"))+a,h=parseFloat(i.getAttribute("y"))+a;c.setAttribute("cx",d),c.setAttribute("cy",h),c.setAttribute("r",.5*a),c.setAttribute("stroke-width","2.6315789473684212"),c.setAttribute("fill","none"),c.setAttribute("class","circle-label"),c.setAttribute("stroke",l),c.setAttribute("id",`current-move-${e}-${r}`),c.setAttribute("class",`current-move-${s}-${o}-${e}-${r}`),t.appendChild(c)}}function updateBoard(t,e,r,n,s){for(let o=0;o<19;o++)for(let l=0;l<19;l++){let i=document.getElementById(`stone-${o}-${l}-${e}-${r}`);i&&("b"===t[o][l]?i.setAttribute("href",n.src):"w"===t[o][l]?i.setAttribute("href",s.src):i.setAttribute("href",""))}}function createGoBoardSVG(t,e,r,n){const s="http://www.w3.org/2000/svg",o=19,l=50,i=600,u=i/18,a=document.createElementNS(s,"svg");a.setAttributeNS(null,"viewBox","0 0 700 700"),a.setAttributeNS(null,"class","board"),a.setAttributeNS(null,"id",`board-${r}-${n}`),a.style.overflow="visible",a.style.width="100%",a.style.height="100%";const c=document.createElementNS(s,"rect");c.setAttributeNS(null,"x",l),c.setAttributeNS(null,"y",l),c.setAttributeNS(null,"width",i),c.setAttributeNS(null,"height",i),c.setAttributeNS(null,"fill","rgba(0, 0, 0, 0.05)"),a.appendChild(c);const d=document.createElementNS(s,"g");d.setAttributeNS(null,"class","label"),a.appendChild(d);const h=document.createElementNS(s,"g");h.setAttributeNS(null,"class","lines"),a.appendChild(h);for(let t=0;t<o;t++){const e=l+t*u,r=document.createElementNS(s,"line");r.setAttributeNS(null,"x1",l),r.setAttributeNS(null,"y1",e),r.setAttributeNS(null,"x2",650),r.setAttributeNS(null,"y2",e),r.setAttributeNS(null,"stroke","#000"),h.appendChild(r);const n=document.createElementNS(s,"line");n.setAttributeNS(null,"x1",e),n.setAttributeNS(null,"y1",l),n.setAttributeNS(null,"x2",e),n.setAttributeNS(null,"y2",650),n.setAttributeNS(null,"stroke","#000"),h.appendChild(n)}[{x:3,y:3},{x:9,y:3},{x:15,y:3},{x:3,y:9},{x:9,y:9},{x:15,y:9},{x:3,y:15},{x:9,y:15},{x:15,y:15}].forEach((t=>{const e=document.createElementNS(s,"circle");e.setAttributeNS(null,"cx",l+t.x*u),e.setAttributeNS(null,"cy",l+t.y*u),e.setAttributeNS(null,"r",5),e.setAttributeNS(null,"fill","#000"),a.appendChild(e)}));for(let t=0;t<o;t++){const e=l+t*u,r=o-t,n=String.fromCharCode("A".charCodeAt(0)+(t>=8?t+1:t)),i=document.createElementNS(s,"text");i.setAttributeNS(null,"x",e),i.setAttributeNS(null,"y",25),i.setAttributeNS(null,"font-size","21"),i.setAttributeNS(null,"text-anchor","middle"),i.setAttributeNS(null,"dy","0.35em"),i.setAttributeNS(null,"stroke","#080808"),i.setAttributeNS(null,"fill","#080808"),i.textContent=n,d.appendChild(i);const a=i.cloneNode(!0);a.setAttributeNS(null,"y",675),d.appendChild(a);const c=document.createElementNS(s,"text");c.setAttributeNS(null,"x",25),c.setAttributeNS(null,"y",e),c.setAttributeNS(null,"font-size","21"),c.setAttributeNS(null,"text-anchor","middle"),c.setAttributeNS(null,"dy","0.35em"),c.setAttributeNS(null,"stroke","#080808"),c.setAttributeNS(null,"fill","#080808"),c.textContent=r,d.appendChild(c);const h=c.cloneNode(!0);h.setAttributeNS(null,"x",675),d.appendChild(h)}const S=document.createElementNS(s,"g");S.setAttributeNS(null,"id",`stonesGroup-${r}-${n}`),a.appendChild(S);for(let t=0;t<o;t++)for(let e=0;e<o;e++){const o=l+t*u,i=l+e*u,a=document.createElementNS(s,"image");a.setAttributeNS(null,"x",o-16.5),a.setAttributeNS(null,"y",i-16.5),a.setAttributeNS(null,"width",33),a.setAttributeNS(null,"height",33),a.setAttributeNS("http://www.w3.org/1999/xlink","href",""),a.setAttributeNS(null,"id",`stone-${t}-${e}-${r}-${n}`),S.appendChild(a)}const m=document.getElementById(t),A=m.parentElement,b=Math.min(A.clientWidth,A.clientHeight);m?A?(m.style.width=`${b}px`,m.style.height=`${b}px`,m.style.backgroundImage=`url(${e.src})`,m.innerHTML="",m.appendChild(a)):console.error(`Parent element of '${t}' not found.`):console.error(`Element with ID '${t}' not found.`)}function loadSocket(){const t=io("https://online-go.com",{transports:["websocket"]});return t.on("connect",(()=>{console.log("OGS connected"),t.emit("hostinfo"),t.emit("authenticate",{device_id:"bubble-viewer"})})),t.on("hostinfo",(t=>{console.log("Termination server",t)})),t.on("authenticate",(t=>{console.log(t)})),t.on("disconnect",(()=>{console.log("Disconnected from OGS. Attempting to reconnect...")})),t.on("error",(t=>{console.error("Socket connection error:",t)})),t}
  </script>
</body>
</html>
